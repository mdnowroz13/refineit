# .github/actions/refineit-action/action.yml
name: "RefineIt (run analyzer)"
description: "Run the RefineIt static analyzer. Optionally create a PR with fixes."
author: "RefineIt Team"

inputs:
  args:
    description: "Extra CLI args"
    required: false
    default: '--dry-run --export-report refineit-report.json'
  create-pr:
    description: "If 'true', create PR"
    required: false
    default: 'false'
  push-branch:
    description: "Branch name"
    required: false
    default: ''
  working-directory:
    description: "Path"
    required: false
    default: '.'
  push_token:
    description: "GitHub token"
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Move to working directory
      if: ${{ inputs.working-directory != '.' }}
      run: cd "${{ inputs.working-directory }}"
      shell: bash

    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci --silent --no-audit --no-fund
          npm run build
        fi
      shell: bash

    - name: Run RefineIt analyzer
      id: run_refineit
      run: |
        set -e

        # Force remove ephemeral/CI build artifacts to avoid "dirty workspace"
        rm -rf dist *.tsbuildinfo refineit-report.json refineit-debug.json || true
        git checkout -- . || true

        echo "Running: npx refineit ${{ inputs.args }}"
        # Run but do not fail the whole job if refineit returns non-zero; capture exit code
        npx refineit ${{ inputs.args }} || true
      shell: bash

    - name: Upload report artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: refineit-report
        path: |
          refineit-report.json
          refineit-debug.json
        retention-days: 7

    - name: Create branch & PR
      if: ${{ inputs.create-pr == 'true' && inputs.push_token != '' }}
      run: |
        set -e

        # Safety: require --apply
        echo "${{ inputs.args }}" | grep -q -- '--apply' || (echo "Refuse: --apply not present. Aborting." && exit 1)

        git config user.name "refineit-bot"
        git config user.email "ci@refineit.local"

        TARGET_BRANCH="${{ inputs.push-branch || 'refineit/auto-fixes' }}"
        BASE_BRANCH="main"

        REMOTE_URL="https://x-access-token:${{ inputs.push_token }}@github.com/${{ github.repository }}"
        git remote set-url origin "$REMOTE_URL"

        # Fetch fresh refs
        git fetch origin "$BASE_BRANCH":"$BASE_BRANCH" || true
        git fetch origin "$TARGET_BRANCH" || true

        # Create fresh branch from origin/main
        if git show-ref --verify --quiet "refs/heads/$TARGET_BRANCH"; then
          git branch -D "$TARGET_BRANCH"
        fi
        git checkout -b "$TARGET_BRANCH" "origin/$BASE_BRANCH"

        # Commit any changes made by refineit (if present)
        if [ -n "$(git status --porcelain)" ]; then
          git add -A
          git commit -m "refineit: apply suggested fixes"
        else
          echo "No changes to commit."
        fi

        # Push (force-with-lease to avoid overwriting unexpected remote updates)
        git push --set-upstream origin "$TARGET_BRANCH" --force-with-lease

        # Create PR via GitHub API (best-effort)
        PR_BODY='{"title":"refineit: suggested import fixes","head":"'"$TARGET_BRANCH"'","base":"'"$BASE_BRANCH"'","body":"Automated fixes."}'
        curl -s -X POST -H "Authorization: token ${{ inputs.push_token }}" -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/${{ github.repository }}/pulls -d "$PR_BODY" > /dev/null
      shell: bash
