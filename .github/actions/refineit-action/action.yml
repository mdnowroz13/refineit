name: "RefineIt (run analyzer)"
description: "Run the RefineIt static analyzer. Optionally create a PR with fixes."
author: "RefineIt Team"
branding:
  icon: "tools"
  color: "blue"

inputs:
  args:
    description: "Extra CLI args passed to refineit."
    required: false
    default: '--dry-run --export-report refineit-report.json'
  create-pr:
    description: "If 'true', attempt to create a PR with changes."
    required: false
    default: 'false'
  push-branch:
    description: "Branch name to use when creating PRs."
    required: false
    default: ''
  working-directory:
    description: "Path inside the repository to run refineit from."
    required: false
    default: '.'
  push_token:
    description: "GitHub token for pushing changes"
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Move to working directory
      if: inputs.working-directory != '.'
      run: cd "${{ inputs.working-directory }}"
      shell: bash

    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci --silent --no-audit --no-fund
        fi
      shell: bash

    - name: Run RefineIt analyzer
      id: run_refineit
      run: |
        set -e
        echo "Running: npx refineit ${{ inputs.args }}"
        npx refineit ${{ inputs.args }} || true
      shell: bash

    - name: Upload report artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: refineit-report
        path: |
          refineit-report.json
          refineit-debug.json
        retention-days: 7

    - name: Create branch & PR
      if: inputs.create-pr == 'true' && inputs.push_token != ''
      run: |
        set -e
        # Logic to create PR if enabled
        echo "Verifying --apply present in args"
        echo "${{ inputs.args }}" | grep -q -- '--apply' || (echo "Refuse: --apply not present. Aborting." && exit 1)

        BRANCH="${{ inputs.push-branch }}"
        if [ -z "$BRANCH" ]; then
          BRANCH="refineit/auto-fixes-${GITHUB_RUN_ID}"
        fi

        git config user.name "refineit-bot"
        git config user.email "refineit-bot@users.noreply.github.com"

        git checkout -b "$BRANCH"
        git add -A
        if git diff --cached --quiet; then
          echo "No changes to commit."
          exit 0
        fi
        git commit -m "refineit: apply suggested fixes"
        
        git push "https://x-access-token:${{ inputs.push_token }}@github.com/${{ github.repository }}" "HEAD:$BRANCH"
        
        # Create PR using API or GH CLI
        PR_BODY='{"title":"refineit: suggested import fixes","head":"'"$BRANCH"'","base":"'"${GITHUB_REF##refs/heads/}"'","body":"Automated fixes."}'
        curl -s -X POST -H "Authorization: token ${{ inputs.push_token }}" -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/${{ github.repository }}/pulls -d "$PR_BODY" > /dev/null
      shell: bash