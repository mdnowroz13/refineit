# .github/actions/refineit-action/action.yml
name: "RefineIt (run analyzer)"
description: "Run the RefineIt static analyzer. Optionally create a PR with fixes."
# author is optional; keep for clarity
author: "RefineIt Team"

inputs:
  args:
    description: "Extra CLI args"
    required: false
    default: "--dry-run --export-report refineit-report.json"
  create-pr:
    description: "If 'true', create PR"
    required: false
    default: "false"
  push-branch:
    description: "Branch name (if empty, defaults to refineit/auto-fixes)"
    required: false
    default: ""
  working-directory:
    description: "Path"
    required: false
    default: "."
  push_token:
    description: "GitHub token (used to push/create PR)"
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "18"
        cache: "npm"

    - name: Move to working directory
      if: ${{ inputs.working-directory != '.' }}
      run: |
        cd "${{ inputs.working-directory }}"
      shell: bash

    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci --silent --no-audit --no-fund
          npm run build
        fi
      shell: bash

    - name: Run RefineIt analyzer
      id: run_refineit
      run: |
        set -euo pipefail

        # Force remove ephemeral/CI build artifacts to avoid "dirty workspace"
        rm -rf dist *.tsbuildinfo refineit-report.json refineit-debug.json || true

        # Clean any local untracked files (safe best-effort)
        git clean -fdx || true
        git reset --hard || true

        echo "Running: npx refineit ${{ inputs.args }}"
        # Run refineit but don't fail the whole step (we want to always upload artifacts)
        npx refineit ${{ inputs.args }} || true
      shell: bash

    - name: Upload report artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: refineit-report
        path: |
          refineit-report.json
          refineit-debug.json
        retention-days: 7

    - name: Create branch & PR
      if: ${{ inputs.create-pr == 'true' && inputs.push_token != '' }}
      run: |
        set -euo pipefail
        # Ensure --apply present
        echo "${{ inputs.args }}" | grep -q -- '--apply' || (echo "Refuse: --apply not present. Aborting." && exit 1)

        git config user.name "refineit-bot"
        git config user.email "ci@refineit.local"

        # Configure branches
        TARGET_BRANCH="${{ inputs.push-branch }}"
        if [ -z "$TARGET_BRANCH" ]; then
          TARGET_BRANCH="refineit/auto-fixes"
        fi
        BASE_BRANCH="main"

        # Set authenticated remote
        REMOTE_URL="https://x-access-token:${{ inputs.push_token }}@github.com/${{ github.repository }}"
        git remote set-url origin "$REMOTE_URL"

        # Fetch remote refs safely (do not fetch into local checked out branch)
        git fetch --no-tags origin "$BASE_BRANCH" || true
        git fetch --no-tags origin "$TARGET_BRANCH" || true

        # Create fresh branch from origin/$BASE_BRANCH if available
        if git ls-remote --exit-code --heads origin "$BASE_BRANCH" >/dev/null 2>&1; then
          # Safe branch creation
          git checkout -b "$TARGET_BRANCH" "origin/$BASE_BRANCH"
        else
          # Fallback: create branch from current HEAD (origin/main)
          git checkout -b "$TARGET_BRANCH"
        fi

        # Commit changes if present
        if [ -n "$(git status --porcelain)" ]; then
          git add -A
          git commit -m "refineit: apply suggested fixes"

          echo "Changes detected and committed. Pushing branch..."
          # Push and create PR
          git push --set-upstream origin "$TARGET_BRANCH" --force-with-lease

          # Build JSON payload without relying on jq
          read -r -d '' PR_BODY <<'JSON' || true
{"title":"refineit: suggested fix applied","head":"'"$TARGET_BRANCH"'","base":"'"$BASE_BRANCH"'","body":"Automated fixes from RefineIt."}
JSON

          echo "Attempting to create Pull Request (response follows) ..."
          # Use curl silent+show-error (sS); this prints the API response (for debug) but hides headers/secrets.
          RESPONSE=$(curl -sS -X POST -H "Authorization: token ${{ inputs.push_token }}" -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls -d "$PR_BODY" || true)
          echo "PR API response: $RESPONSE"
        else
          echo "No changes to commit. Skipping branch push and PR creation."
        fi
      shell: bash